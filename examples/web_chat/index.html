<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI Chat - 智普AI聊天助手</title>
        <link rel="stylesheet" href="/static/style.css" />
    </head>
    <body>
        <div class="chat-container">
            <header class="chat-header">
                <div class="header-content">
                    <h1>🤖 AI Assistant</h1>
                    <div class="status-indicator">
                        <span class="status-dot online"></span>
                        <span class="status-text">在线</span>
                    </div>
                </div>
            </header>

            <div class="chat-messages" id="chatMessages">
                <div class="message assistant-message">
                    <div class="message-avatar">
                        <div class="avatar ai-avatar">🤖</div>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            您好！我是智普AI助手，有什么可以帮助您的吗？
                        </div>
                        <div class="message-time">刚刚</div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea
                        id="messageInput"
                        class="message-input"
                        placeholder="输入您的消息..."
                        rows="1"
                    ></textarea>
                    <button id="sendButton" class="send-button">
                        <span class="send-icon">➤</span>
                    </button>
                </div>
                <div class="input-footer">
                    <small class="input-hint"
                        >按 Enter 发送，Shift+Enter 换行</small
                    >
                </div>
            </div>
        </div>

        <div
            class="typing-indicator"
            id="typingIndicator"
            style="display: none"
        >
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span>AI 正在思考...</span>
        </div>

        <script>
            // 全局变量
            let currentSessionId = null;
            let isStreaming = false;
            let currentStreamingElement = null;

            // DOM 元素缓存
            const elements = {
                chatMessages: null,
                messageInput: null,
                sendButton: null,
                typingIndicator: null,
            };

            // 初始化
            function initializeChat() {
                // 缓存DOM元素
                elements.chatMessages = document.getElementById("chatMessages");
                elements.messageInput = document.getElementById("messageInput");
                elements.sendButton = document.getElementById("sendButton");
                elements.typingIndicator =
                    document.getElementById("typingIndicator");

                // 重置状态
                isStreaming = false;
                currentStreamingElement = null;

                // 从 localStorage 恢复会话ID
                const savedSessionId = localStorage.getItem("chatSessionId");
                if (savedSessionId) {
                    currentSessionId = savedSessionId;
                }

                // 设置事件监听器
                setupEventListeners();

                // 调整输入框高度
                adjustInputHeight();
            }

            // 设置事件监听器
            function setupEventListeners() {
                // 发送按钮点击事件
                elements.sendButton.addEventListener("click", function (event) {
                    if (elements.sendButton.disabled) {
                        event.preventDefault();
                        return;
                    }
                    sendMessage();
                });

                // 输入框键盘事件
                elements.messageInput.addEventListener(
                    "keydown",
                    function (event) {
                        if (event.key === "Enter" && !event.shiftKey) {
                            event.preventDefault();
                            sendMessage();
                        }
                    },
                );

                // 输入框事件 - 更新发送按钮状态
                elements.messageInput.addEventListener(
                    "input",
                    updateSendButton,
                );

                // 自动调整输入框高度
                elements.messageInput.addEventListener(
                    "input",
                    adjustInputHeight,
                );

                // 初始化按钮状态
                updateSendButton();
            }

            // 更新发送按钮状态
            function updateSendButton() {
                const hasContent =
                    elements.messageInput.value.trim().length > 0;
                elements.sendButton.disabled = !hasContent || isStreaming;
            }

            // 调整输入框高度
            function adjustInputHeight() {
                elements.messageInput.style.height = "auto";
                elements.messageInput.style.height =
                    elements.messageInput.scrollHeight + "px";
            }

            // 发送消息
            async function sendMessage() {
                const message = elements.messageInput.value.trim();

                if (!message || isStreaming) {
                    return;
                }

                // 添加用户消息到界面
                addMessage(message, "user");

                // 清空输入框
                elements.messageInput.value = "";
                adjustInputHeight();

                // 设置流式状态
                isStreaming = true;
                updateSendButton();
                elements.typingIndicator.style.display = "flex";

                // 立即添加AI消息占位符
                addMessage("", "assistant", false, true);
                currentStreamingElement =
                    elements.chatMessages.lastElementChild;
                if (currentStreamingElement) {
                    currentStreamingElement.messageTextEl =
                        currentStreamingElement.querySelector(".message-text");
                    currentStreamingElement.timeEl =
                        currentStreamingElement.querySelector(".message-time");
                    if (currentStreamingElement.messageTextEl) {
                        currentStreamingElement.messageTextEl.innerHTML =
                            '<span class="typing-cursor">▌</span>';
                    }
                }

                try {
                    await sendChatMessage(message);
                } catch (error) {
                    addMessage(
                        "抱歉，发送消息时出现错误，请稍后重试。",
                        "assistant",
                        true,
                    );
                } finally {
                    isStreaming = false;
                    updateSendButton();
                    elements.typingIndicator.style.display = "none";
                    currentStreamingElement = null;
                    elements.messageInput.focus();
                }
            }

            // 发送聊天消息到服务器
            async function sendChatMessage(message) {
                const requestData = {
                    message: message,
                    session_id: currentSessionId,
                };

                try {
                    // 尝试流式接口
                    const response = await fetch("/api/chat/stream", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Accept: "text/event-stream",
                            "Cache-Control": "no-cache",
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    // 处理流式响应
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });

                        // 处理SSE数据
                        const lines = buffer.split("\n");
                        buffer = lines.pop() || "";

                        for (const line of lines) {
                            if (line.trim() === "") continue;
                            if (line.startsWith("data: ")) {
                                try {
                                    const data = JSON.parse(line.slice(6));

                                    if (
                                        data.content &&
                                        currentStreamingElement &&
                                        currentStreamingElement.messageTextEl
                                    ) {
                                        // 替换占位符或追加内容
                                        if (
                                            currentStreamingElement.messageTextEl.querySelector(
                                                ".typing-cursor",
                                            )
                                        ) {
                                            currentStreamingElement.messageTextEl.textContent =
                                                data.content;
                                        } else {
                                            currentStreamingElement.messageTextEl.textContent +=
                                                data.content;
                                        }

                                        scrollToBottom();
                                    }

                                    if (data.session_id) {
                                        currentSessionId = data.session_id;
                                        localStorage.setItem(
                                            "chatSessionId",
                                            currentSessionId,
                                        );
                                    }

                                    if (data.done && currentStreamingElement) {
                                        if (currentStreamingElement.timeEl) {
                                            currentStreamingElement.timeEl.textContent =
                                                new Date().toLocaleTimeString(
                                                    "zh-CN",
                                                );
                                        }
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    // 静默处理JSON解析错误
                                }
                            }
                        }
                    }
                } catch (error) {
                    // 降级到普通接口
                    const response = await fetch("/api/chat", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    addMessage(data.reply, "assistant");

                    if (data.session_id) {
                        currentSessionId = data.session_id;
                        localStorage.setItem("chatSessionId", currentSessionId);
                    }
                }
            }

            // 添加消息到聊天界面
            function addMessage(
                text,
                sender,
                isError = false,
                isStreaming = false,
            ) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${sender}-message`;

                const avatarDiv = document.createElement("div");
                avatarDiv.className = "message-avatar";

                const avatar = document.createElement("div");
                avatar.className =
                    sender === "user"
                        ? "avatar user-avatar"
                        : "avatar ai-avatar";
                avatar.textContent = sender === "user" ? "👤" : "🤖";

                avatarDiv.appendChild(avatar);

                const contentDiv = document.createElement("div");
                contentDiv.className = "message-content";

                const textDiv = document.createElement("div");
                textDiv.className = "message-text";
                if (isError) {
                    textDiv.classList.add("error-message");
                }
                textDiv.textContent = text;

                const timeDiv = document.createElement("div");
                timeDiv.className = "message-time";
                timeDiv.textContent = new Date().toLocaleTimeString("zh-CN");

                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(timeDiv);

                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);

                elements.chatMessages.appendChild(messageDiv);

                if (!isStreaming) {
                    scrollToBottom();
                }
            }

            // 滚动到底部（节流）
            let scrollTimeout;
            function scrollToBottom() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    elements.chatMessages.scrollTop =
                        elements.chatMessages.scrollHeight;
                }, 16); // 约60fps
            }

            // 页面加载完成后初始化
            document.addEventListener("DOMContentLoaded", initializeChat);
        </script>
    </body>
</html>
