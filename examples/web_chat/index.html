<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI Chat - 智普AI聊天助手</title>
        <link rel="stylesheet" href="/static/style.css" />
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
        <script>
            // Ensure Prism Autoloader fetches languages from CDN reliably
            if (window.Prism && Prism.plugins && Prism.plugins.autoloader) {
                Prism.plugins.autoloader.languages_path =
                    'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
            }
        </script>
    </head>
    <body>
        <div class="chat-container">
            <header class="chat-header">
                <div class="header-content">
                    <h1>🤖 AI Assistant</h1>
                    <div class="status-indicator">
                        <span class="status-dot online"></span>
                        <span class="status-text">在线</span>
                    </div>
                </div>
            </header>

            <div class="chat-messages" id="chatMessages">
                <div class="message assistant-message">
                    <div class="message-avatar">
                        <div class="avatar ai-avatar">
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"
                                />
                                <path d="M9 12l2 2 4-4" />
                            </svg>
                        </div>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            您好！我是智普AI助手，有什么可以帮助您的吗？
                        </div>
                        <div class="message-time">刚刚</div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea
                        id="messageInput"
                        class="message-input"
                        placeholder="输入您的消息..."
                        rows="1"
                    ></textarea>
                    <button id="thinkToggle" class="think-toggle" title="Think 模式：关闭" aria-pressed="false">
                        <span class="brain">🧠</span>
                        <span class="label">Think</span>
                    </button>
                    <button id="sendButton" class="send-button">
                        <span class="send-icon">➤</span>
                    </button>
                </div>
                <div class="input-footer">
                    <small class="input-hint"
                        >按 Enter 发送，Shift+Enter 换行</small
                    >
                </div>
            </div>
        </div>

        <div
            class="typing-indicator"
            id="typingIndicator"
            style="display: none"
        >
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span>AI 正在思考...</span>
        </div>

        <script>
            // 配置 marked.js
            marked.setOptions({
                highlight: function (code, lang) {
                    if (Prism.languages[lang]) {
                        try {
                            return Prism.highlight(
                                code,
                                Prism.languages[lang],
                                lang,
                            );
                        } catch (e) {
                            console.warn("Prism highlighting failed:", e);
                        }
                    }
                    return code;
                },
                breaks: true,
                gfm: true,
                tables: true,
                sanitize: false, // 我们使用 DOMPurify 来处理安全性
                smartLists: true,
                smartypants: true,
            });

            // 自定义渲染器来添加代码块复制按钮
            const renderer = new marked.Renderer();
            const originalCodeRenderer = renderer.code.bind(renderer);

            renderer.code = function (code, language) {
                const copyButton = `<button class="copy-button" onclick="copyCode(this)" title="复制代码">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>`;

                // 默认语言，避免无语言时丢失样式（Prism 依赖 language-*）
                const lang = (typeof language === "string" && language.trim()) ? language.toLowerCase() : "plaintext";
                let codeHtml = originalCodeRenderer(code, lang);

                // 确保 <pre> 和 <code> 至少有一个 language-* 类，便于最终高亮
                if (!/language-/.test(codeHtml)) {
                    codeHtml = codeHtml
                        .replace(/<pre(?![^>]*class=)/, `<pre class="language-${lang}"`)
                        .replace(/<code(?![^>]*class=)/, `<code class="language-${lang}"`);
                }
                return `<div class="code-block-container">${codeHtml}${copyButton}</div>`;
            };

            marked.use({ renderer });

            // 复制代码功能
            function copyCode(button) {
                const codeBlock = button.parentElement.querySelector("code");
                const text = codeBlock.textContent;

                navigator.clipboard
                    .writeText(text)
                    .then(() => {
                        const originalText = button.innerHTML;
                        button.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>`;
                        button.classList.add("copied");

                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove("copied");
                        }, 2000);
                    })
                    .catch((err) => {
                        console.error("复制失败:", err);
                    });
            }

            // 全局变量
            let currentSessionId = null;
            let isStreaming = false;
            let currentStreamingElement = null;
            let thinkMode = JSON.parse(localStorage.getItem("thinkMode") || "false");
            // 滚动与高亮控制
            let prismTimeout = null;
            let autoStick = true;

            // Frame-batched streaming renderer with a blinking caret and partial highlight
            let streamRenderScheduled = false;
            const enablePartialHighlight = true;

            function ensureStreamContainers(rootEl) {
                if (!rootEl) return { stable: null, tail: null };
                let stable = rootEl.querySelector('.stable');
                let tail = rootEl.querySelector('.tail');
                if (!stable || !tail) {
                    rootEl.innerHTML = '<div class="stable"></div><div class="tail"><span class="typing-cursor">▌</span></div>';
                    stable = rootEl.querySelector('.stable');
                    tail = rootEl.querySelector('.tail');
                }
                return { stable, tail };
            }

            function computeStableEnd(markdown) {
                // Find last balanced code fence ```
                const fenceRe = /```/g;
                let m, count = 0, lastPos = -1;
                while ((m = fenceRe.exec(markdown)) !== null) {
                    count++;
                    lastPos = m.index;
                }
                if (count % 2 === 0) return markdown.length;
                return lastPos >= 0 ? lastPos : 0;
            }

            function scheduleStreamRender() {
                if (streamRenderScheduled) return;
                streamRenderScheduled = true;
                requestAnimationFrame(() => {
                    streamRenderScheduled = false;
                    if (!currentStreamingElement || !currentStreamingElement.messageTextEl) return;
                    const el = currentStreamingElement.messageTextEl;
                    const { stable, tail } = ensureStreamContainers(el);
                    const raw = el.getAttribute('data-raw-text') || '';

                    if (!enablePartialHighlight) {
                        el.innerHTML = DOMPurify.sanitize(marked.parse(raw)) + '<span class="typing-cursor">▌</span>';
                        scrollToBottom();
                        return;
                    }

                    const prevStableLen = parseInt(el.getAttribute('data-stable-len') || '0', 10);
                    const stableEnd = computeStableEnd(raw);

                    if (stableEnd !== prevStableLen && stable) {
                        const stableMd = raw.slice(0, stableEnd);
                        stable.innerHTML = DOMPurify.sanitize(marked.parse(stableMd));
                        try { Prism.highlightAllUnder(stable); } catch (_) {}
                        el.setAttribute('data-stable-len', String(stableEnd));
                    }

                    if (tail) {
                        const tailMd = raw.slice(stableEnd);
                        tail.innerHTML = DOMPurify.sanitize(marked.parse(tailMd)) + '<span class="typing-cursor">▌</span>';
                    }

                    scrollToBottom();
                });
            }

            // DOM 元素缓存
            const elements = {
                chatMessages: null,
                messageInput: null,
                sendButton: null,
                thinkToggle: null,
                typingIndicator: null,
            };

            // 初始化
            function initializeChat() {
                // 缓存DOM元素
                elements.chatMessages = document.getElementById("chatMessages");
                elements.messageInput = document.getElementById("messageInput");
                elements.sendButton = document.getElementById("sendButton");
                elements.thinkToggle = document.getElementById("thinkToggle");
                elements.typingIndicator =
                    document.getElementById("typingIndicator");

                // 重置状态
                isStreaming = false;
                currentStreamingElement = null;

                // 从 localStorage 恢复会话ID
                const savedSessionId = localStorage.getItem("chatSessionId");
                if (savedSessionId) {
                    currentSessionId = savedSessionId;
                }

                // 设置事件监听器
                setupEventListeners();

                // 初始化 Think 按钮 UI
                updateThinkToggleUI();

                // 调整输入框高度
                adjustInputHeight();
            }

            // 设置事件监听器
            function setupEventListeners() {
                // 发送按钮点击事件
                elements.sendButton.addEventListener("click", function (event) {
                    if (elements.sendButton.disabled) {
                        event.preventDefault();
                        return;
                    }
                    sendMessage();
                });

                // Think 按钮事件
                if (elements.thinkToggle) {
                    elements.thinkToggle.addEventListener("click", toggleThinkMode);
                }

                // 聊天区域滚动状态监听（仅在接近底部时才自动跟随）
                elements.chatMessages.addEventListener("scroll", function(){
                    const el = elements.chatMessages;
                    if (!el) return;
                    autoStick = (el.scrollHeight - el.scrollTop - el.clientHeight) < 80;
                });

                // 输入框键盘事件
                elements.messageInput.addEventListener(
                    "keydown",
                    function (event) {
                        if (event.key === "Enter" && !event.shiftKey) {
                            event.preventDefault();
                            sendMessage();
                        }
                    },
                );

                // 输入框事件 - 更新发送按钮状态
                elements.messageInput.addEventListener(
                    "input",
                    updateSendButton,
                );

                // 自动调整输入框高度
                elements.messageInput.addEventListener(
                    "input",
                    adjustInputHeight,
                );

                // 初始化按钮状态
                updateSendButton();
            }

            // 更新发送按钮状态
            function updateSendButton() {
                const hasContent =
                    elements.messageInput.value.trim().length > 0;
                elements.sendButton.disabled = !hasContent || isStreaming;
            }

            // 调整输入框高度
            function adjustInputHeight() {
                elements.messageInput.style.height = "auto";
                elements.messageInput.style.height =
                    elements.messageInput.scrollHeight + "px";
            }

            // 切换 Think 模式
            function toggleThinkMode() {
                thinkMode = !thinkMode;
                localStorage.setItem("thinkMode", JSON.stringify(thinkMode));
                updateThinkToggleUI();
            }

            function updateThinkToggleUI() {
                if (!elements.thinkToggle) return;
                elements.thinkToggle.classList.toggle("active", thinkMode);
                elements.thinkToggle.setAttribute("aria-pressed", thinkMode ? "true" : "false");
                elements.thinkToggle.title = thinkMode ? "Think 模式：开启" : "Think 模式：关闭";
            }

            // 发送消息
            async function sendMessage() {
                const message = elements.messageInput.value.trim();

                if (!message || isStreaming) {
                    return;
                }

                // 添加用户消息到界面
                addMessage(message, "user");

                // 清空输入框
                elements.messageInput.value = "";
                adjustInputHeight();

                // 设置流式状态
                isStreaming = true;
                updateSendButton();
                elements.typingIndicator.style.display = "flex";

                // 立即添加AI消息占位符
                addMessage("", "assistant", false, true);
                currentStreamingElement =
                    elements.chatMessages.lastElementChild;
                if (currentStreamingElement) {
                    currentStreamingElement.messageTextEl =
                        currentStreamingElement.querySelector(".message-text");
                    currentStreamingElement.timeEl =
                        currentStreamingElement.querySelector(".message-time");
                    if (currentStreamingElement.messageTextEl) {
                        currentStreamingElement.messageTextEl.setAttribute("data-raw-text", "");
                        currentStreamingElement.messageTextEl.setAttribute("data-stable-len", "0");
                        currentStreamingElement.messageTextEl.innerHTML =
                            '<div class="stable"></div><div class="tail"><span class="typing-cursor">▌</span></div>';
                    }
                }

                try {
                    await sendChatMessage(message);
                } catch (error) {
                    addMessage(
                        "抱歉，发送消息时出现错误，请稍后重试。",
                        "assistant",
                        true,
                    );
                } finally {
                    isStreaming = false;
                    updateSendButton();
                    elements.typingIndicator.style.display = "none";
                    currentStreamingElement = null;
                    elements.messageInput.focus();
                }
            }

            // 发送聊天消息到服务器
            async function sendChatMessage(message) {
                const requestData = {
                    message: message,
                    session_id: currentSessionId,
                    think: thinkMode,
                };

                try {
                    // 尝试流式接口
                    const response = await fetch("/api/chat/stream", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Accept: "text/event-stream",
                            "Cache-Control": "no-cache",
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    // 处理流式响应
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });

                        // 处理SSE数据
                        const lines = buffer.split("\n");
                        buffer = lines.pop() || "";

                        for (const line of lines) {
                            if (line.trim() === "") continue;
                            if (line.startsWith("data: ")) {
                                try {
                                    const data = JSON.parse(line.slice(6));

                                    if (
                                        data.content &&
                                        currentStreamingElement &&
                                        currentStreamingElement.messageTextEl
                                    ) {
                                        // 替换占位符或追加内容
                                        // 累积原始文本，渲染由 requestAnimationFrame 批处理
                                        const prevRaw = currentStreamingElement.messageTextEl.getAttribute("data-raw-text") || "";
                                        const nextRaw = prevRaw + data.content;
                                        currentStreamingElement.messageTextEl.setAttribute("data-raw-text", nextRaw);
                                        scheduleStreamRender();

                                        scrollToBottom();
                                    }

                                    if (data.session_id) {
                                        currentSessionId = data.session_id;
                                        localStorage.setItem(
                                            "chatSessionId",
                                            currentSessionId,
                                        );
                                    }

                                    if (data.done && currentStreamingElement) {
                                        if (currentStreamingElement.timeEl) {
                                            currentStreamingElement.timeEl.textContent =
                                                new Date().toLocaleTimeString(
                                                    "zh-CN",
                                                );
                                        }
                                        // 流结束：去除光标，渲染最终内容并一次性高亮
                                        try {
                                            const raw = currentStreamingElement.messageTextEl?.getAttribute('data-raw-text') || '';
                                            currentStreamingElement.messageTextEl.innerHTML = DOMPurify.sanitize(marked.parse(raw));
                                            Prism.highlightAllUnder(currentStreamingElement.messageTextEl);
                                        } catch (e) {
                                            console.warn("Prism final highlight failed:", e);
                                        }
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    // 静默处理JSON解析错误
                                }
                            }
                        }
                    }
                } catch (error) {
                    // 降级到普通接口
                    const response = await fetch("/api/chat", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    addMessage(data.reply, "assistant");

                    if (data.session_id) {
                        currentSessionId = data.session_id;
                        localStorage.setItem("chatSessionId", currentSessionId);
                    }
                }
            }

            // 添加消息到聊天界面
            function addMessage(
                text,
                sender,
                isError = false,
                isStreaming = false,
            ) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${sender}-message`;

                const avatarDiv = document.createElement("div");
                avatarDiv.className = "message-avatar";

                const avatar = document.createElement("div");
                avatar.className =
                    sender === "user"
                        ? "avatar user-avatar"
                        : "avatar ai-avatar";

                if (sender === "user") {
                    avatar.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    `;
                } else {
                    avatar.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                            <path d="M9 12l2 2 4-4"/>
                        </svg>
                    `;
                }

                avatarDiv.appendChild(avatar);

                const contentDiv = document.createElement("div");
                contentDiv.className = "message-content";

                const textDiv = document.createElement("div");
                textDiv.className = "message-text";
                if (isError) {
                    textDiv.classList.add("error-message");
                    textDiv.textContent = text;
                } else if (sender === "assistant") {
                    // 对于AI消息，渲染markdown
                    textDiv.innerHTML = DOMPurify.sanitize(marked.parse(text));

                    // 高亮代码块
                    setTimeout(() => {
                        Prism.highlightAllUnder(textDiv);
                    }, 0);
                } else {
                    // 对于用户消息，保持纯文本
                    textDiv.textContent = text;
                }

                const timeDiv = document.createElement("div");
                timeDiv.className = "message-time";
                timeDiv.textContent = new Date().toLocaleTimeString("zh-CN");

                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(timeDiv);

                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);

                elements.chatMessages.appendChild(messageDiv);

                if (!isStreaming) {
                    scrollToBottom();
                }
            }

            // 滚动到底部（节流 + 平滑 + 仅在接近底部时跟随）
            let scrollTimeout;
            function isNearBottom(el) {
                if (!el) return false;
                return (el.scrollHeight - el.scrollTop - el.clientHeight) < 80;
            }
            function scrollToBottom(immediate = false) {
                const el = elements.chatMessages;
                if (!el) return;
                if (!immediate && !isNearBottom(el)) return; // 用户不在底部则不强制跟随
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const top = el.scrollHeight;
                    if (el.scrollTo) {
                        el.scrollTo({ top, behavior: immediate ? "auto" : "smooth" });
                    } else {
                        el.scrollTop = top;
                    }
                }, immediate ? 0 : 80);
            }

            // 页面加载完成后初始化
            document.addEventListener("DOMContentLoaded", initializeChat);
        </script>
    </body>
</html>
