<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI Chat - æ™ºæ™®AIèŠå¤©åŠ©æ‰‹</title>
        <link rel="stylesheet" href="/static/style.css" />
    </head>
    <body>
        <div class="chat-container">
            <header class="chat-header">
                <div class="header-content">
                    <h1>ğŸ¤– AI Assistant</h1>
                    <div class="status-indicator">
                        <span class="status-dot online"></span>
                        <span class="status-text">åœ¨çº¿</span>
                    </div>
                </div>
            </header>

            <div class="chat-messages" id="chatMessages">
                <div class="message assistant-message">
                    <div class="message-avatar">
                        <div class="avatar ai-avatar">ğŸ¤–</div>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºæ™®AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
                        </div>
                        <div class="message-time">åˆšåˆš</div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea
                        id="messageInput"
                        class="message-input"
                        placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..."
                        rows="1"
                    ></textarea>
                    <button id="sendButton" class="send-button">
                        <span class="send-icon">â¤</span>
                    </button>
                </div>
                <div class="input-footer">
                    <small class="input-hint"
                        >æŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ</small
                    >
                </div>
            </div>
        </div>

        <div
            class="typing-indicator"
            id="typingIndicator"
            style="display: none"
        >
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span>AI æ­£åœ¨æ€è€ƒ...</span>
        </div>

        <script>
            // å…¨å±€å˜é‡
            let currentSessionId = null;
            let isStreaming = false;
            let currentStreamingElement = null;

            // DOM å…ƒç´ ç¼“å­˜
            const elements = {
                chatMessages: null,
                messageInput: null,
                sendButton: null,
                typingIndicator: null,
            };

            // åˆå§‹åŒ–
            function initializeChat() {
                // ç¼“å­˜DOMå…ƒç´ 
                elements.chatMessages = document.getElementById("chatMessages");
                elements.messageInput = document.getElementById("messageInput");
                elements.sendButton = document.getElementById("sendButton");
                elements.typingIndicator =
                    document.getElementById("typingIndicator");

                // é‡ç½®çŠ¶æ€
                isStreaming = false;
                currentStreamingElement = null;

                // ä» localStorage æ¢å¤ä¼šè¯ID
                const savedSessionId = localStorage.getItem("chatSessionId");
                if (savedSessionId) {
                    currentSessionId = savedSessionId;
                }

                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupEventListeners();

                // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                adjustInputHeight();
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            function setupEventListeners() {
                // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                elements.sendButton.addEventListener("click", function (event) {
                    if (elements.sendButton.disabled) {
                        event.preventDefault();
                        return;
                    }
                    sendMessage();
                });

                // è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
                elements.messageInput.addEventListener(
                    "keydown",
                    function (event) {
                        if (event.key === "Enter" && !event.shiftKey) {
                            event.preventDefault();
                            sendMessage();
                        }
                    },
                );

                // è¾“å…¥æ¡†äº‹ä»¶ - æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
                elements.messageInput.addEventListener(
                    "input",
                    updateSendButton,
                );

                // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                elements.messageInput.addEventListener(
                    "input",
                    adjustInputHeight,
                );

                // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
                updateSendButton();
            }

            // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
            function updateSendButton() {
                const hasContent =
                    elements.messageInput.value.trim().length > 0;
                elements.sendButton.disabled = !hasContent || isStreaming;
            }

            // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            function adjustInputHeight() {
                elements.messageInput.style.height = "auto";
                elements.messageInput.style.height =
                    elements.messageInput.scrollHeight + "px";
            }

            // å‘é€æ¶ˆæ¯
            async function sendMessage() {
                const message = elements.messageInput.value.trim();

                if (!message || isStreaming) {
                    return;
                }

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
                addMessage(message, "user");

                // æ¸…ç©ºè¾“å…¥æ¡†
                elements.messageInput.value = "";
                adjustInputHeight();

                // è®¾ç½®æµå¼çŠ¶æ€
                isStreaming = true;
                updateSendButton();
                elements.typingIndicator.style.display = "flex";

                // ç«‹å³æ·»åŠ AIæ¶ˆæ¯å ä½ç¬¦
                addMessage("", "assistant", false, true);
                currentStreamingElement =
                    elements.chatMessages.lastElementChild;
                if (currentStreamingElement) {
                    currentStreamingElement.messageTextEl =
                        currentStreamingElement.querySelector(".message-text");
                    currentStreamingElement.timeEl =
                        currentStreamingElement.querySelector(".message-time");
                    if (currentStreamingElement.messageTextEl) {
                        currentStreamingElement.messageTextEl.innerHTML =
                            '<span class="typing-cursor">â–Œ</span>';
                    }
                }

                try {
                    await sendChatMessage(message);
                } catch (error) {
                    addMessage(
                        "æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚",
                        "assistant",
                        true,
                    );
                } finally {
                    isStreaming = false;
                    updateSendButton();
                    elements.typingIndicator.style.display = "none";
                    currentStreamingElement = null;
                    elements.messageInput.focus();
                }
            }

            // å‘é€èŠå¤©æ¶ˆæ¯åˆ°æœåŠ¡å™¨
            async function sendChatMessage(message) {
                const requestData = {
                    message: message,
                    session_id: currentSessionId,
                };

                try {
                    // å°è¯•æµå¼æ¥å£
                    const response = await fetch("/api/chat/stream", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Accept: "text/event-stream",
                            "Cache-Control": "no-cache",
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    // å¤„ç†æµå¼å“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });

                        // å¤„ç†SSEæ•°æ®
                        const lines = buffer.split("\n");
                        buffer = lines.pop() || "";

                        for (const line of lines) {
                            if (line.trim() === "") continue;
                            if (line.startsWith("data: ")) {
                                try {
                                    const data = JSON.parse(line.slice(6));

                                    if (
                                        data.content &&
                                        currentStreamingElement &&
                                        currentStreamingElement.messageTextEl
                                    ) {
                                        // æ›¿æ¢å ä½ç¬¦æˆ–è¿½åŠ å†…å®¹
                                        if (
                                            currentStreamingElement.messageTextEl.querySelector(
                                                ".typing-cursor",
                                            )
                                        ) {
                                            currentStreamingElement.messageTextEl.textContent =
                                                data.content;
                                        } else {
                                            currentStreamingElement.messageTextEl.textContent +=
                                                data.content;
                                        }

                                        scrollToBottom();
                                    }

                                    if (data.session_id) {
                                        currentSessionId = data.session_id;
                                        localStorage.setItem(
                                            "chatSessionId",
                                            currentSessionId,
                                        );
                                    }

                                    if (data.done && currentStreamingElement) {
                                        if (currentStreamingElement.timeEl) {
                                            currentStreamingElement.timeEl.textContent =
                                                new Date().toLocaleTimeString(
                                                    "zh-CN",
                                                );
                                        }
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    // é™é»˜å¤„ç†JSONè§£æé”™è¯¯
                                }
                            }
                        }
                    }
                } catch (error) {
                    // é™çº§åˆ°æ™®é€šæ¥å£
                    const response = await fetch("/api/chat", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestData),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    addMessage(data.reply, "assistant");

                    if (data.session_id) {
                        currentSessionId = data.session_id;
                        localStorage.setItem("chatSessionId", currentSessionId);
                    }
                }
            }

            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
            function addMessage(
                text,
                sender,
                isError = false,
                isStreaming = false,
            ) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${sender}-message`;

                const avatarDiv = document.createElement("div");
                avatarDiv.className = "message-avatar";

                const avatar = document.createElement("div");
                avatar.className =
                    sender === "user"
                        ? "avatar user-avatar"
                        : "avatar ai-avatar";
                avatar.textContent = sender === "user" ? "ğŸ‘¤" : "ğŸ¤–";

                avatarDiv.appendChild(avatar);

                const contentDiv = document.createElement("div");
                contentDiv.className = "message-content";

                const textDiv = document.createElement("div");
                textDiv.className = "message-text";
                if (isError) {
                    textDiv.classList.add("error-message");
                }
                textDiv.textContent = text;

                const timeDiv = document.createElement("div");
                timeDiv.className = "message-time";
                timeDiv.textContent = new Date().toLocaleTimeString("zh-CN");

                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(timeDiv);

                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);

                elements.chatMessages.appendChild(messageDiv);

                if (!isStreaming) {
                    scrollToBottom();
                }
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆèŠ‚æµï¼‰
            let scrollTimeout;
            function scrollToBottom() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    elements.chatMessages.scrollTop =
                        elements.chatMessages.scrollHeight;
                }, 16); // çº¦60fps
            }

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            document.addEventListener("DOMContentLoaded", initializeChat);
        </script>
    </body>
</html>
