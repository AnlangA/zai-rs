<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <h1>ğŸ¤– AI Assistant</h1>
            <div class="status">åœ¨çº¿</div>
        </header>

        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="avatar">ğŸ¤–</div>
                <div class="content">
                    <div class="text">æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</div>
                    <div class="time">åˆšåˆš</div>
                </div>
            </div>
        </div>

        <div class="chat-input">
            <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." rows="1"></textarea>
            <button id="sendButton">å‘é€</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentSessionId = null;
        let isStreaming = false;

        // DOMå…ƒç´ 
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            console.log('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨');

            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendButton.addEventListener('click', sendMessage);

            // è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
            messageInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });

            // è¾“å…¥æ¡†äº‹ä»¶ - æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
            messageInput.addEventListener('input', updateSendButton);

            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            updateSendButton();
        }

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        function updateSendButton() {
            const hasContent = messageInput.value.trim().length > 0;
            sendButton.disabled = !hasContent || isStreaming;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = messageInput.value.trim();

            console.log('å‘é€æ¶ˆæ¯:', message);

            if (!message || isStreaming) {
                console.log('æ¶ˆæ¯ä¸ºç©ºæˆ–æ­£åœ¨æµå¼å“åº”ï¼Œè·³è¿‡å‘é€');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');

            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
            updateSendButton();

            // è®¾ç½®æµå¼çŠ¶æ€
            isStreaming = true;
            updateSendButton();

            try {
                await sendChatRequest(message);
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                addMessage('æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ã€‚', 'assistant');
            } finally {
                isStreaming = false;
                updateSendButton();
            }
        }

        // å‘é€èŠå¤©è¯·æ±‚
        async function sendChatRequest(message) {
            const requestData = {
                message: message,
                session_id: currentSessionId
            };

            console.log('å‘é€è¯·æ±‚:', requestData);

            try {
                // å°è¯•æµå¼æ¥å£
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // å¤„ç†æµå¼å“åº”
                await handleStreamResponse(response);

            } catch (error) {
                console.log('æµå¼æ¥å£å¤±è´¥ï¼Œå°è¯•æ™®é€šæ¥å£:', error);

                // é™çº§åˆ°æ™®é€šæ¥å£
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°å“åº”:', data);

                addMessage(data.reply, 'assistant');

                if (data.session_id) {
                    currentSessionId = data.session_id;
                    localStorage.setItem('chatSessionId', currentSessionId);
                }
            }
        }

        // å¤„ç†æµå¼å“åº”
        async function handleStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let assistantMessage = null;

            console.log('å¼€å§‹å¤„ç†æµå¼å“åº”');

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.trim() === '') continue;
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            console.log('æ”¶åˆ°æµå¼æ•°æ®:', data);

                            if (data.content) {
                                if (!assistantMessage) {
                                    // åˆ›å»ºAIæ¶ˆæ¯
                                    addMessage(data.content, 'assistant');
                                    assistantMessage = chatMessages.lastElementChild;
                                } else {
                                    // æ›´æ–°ç°æœ‰æ¶ˆæ¯
                                    const textElement = assistantMessage.querySelector('.text');
                                    if (textElement) {
                                        textElement.textContent += data.content;
                                    }
                                }
                            }

                            if (data.session_id) {
                                currentSessionId = data.session_id;
                                localStorage.setItem('chatSessionId', currentSessionId);
                            }
                        } catch (e) {
                            console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e);
                        }
                    }
                }
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

            const content = document.createElement('div');
            content.className = 'content';

            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textDiv.textContent = text;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'time';
            timeDiv.textContent = new Date().toLocaleTimeString('zh-CN');

            content.appendChild(textDiv);
            content.appendChild(timeDiv);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>
